@model CustomerAppointmentDtoForUpdate

<div class="container-fluid">
	<div class="row justify-content-center">
		<div class="col-12 col-xl-10">
			<div class="card card-dark bg-dark border-black">
				<div class="card-header">
					<h2 class="h4 text-light mb-0">@Localizer["UpdateCustomerAppointment"]</h2>
				</div>
				<div class="card-body text-light">
					<form method="post" class="single-step-form" asp-action="Update">
						<input type="hidden" asp-for="CustomerAppointmentId" />

						<!-- Preliminary Information -->
						<div class="row g-3 mb-4">
							<div class="col-12">
								<h4 class="text-primary mb-3">@Localizer["AppointmentDetails"]</h4>
							</div>

							<!-- Branch Selection -->
							<div class="col-12 col-md-6">
								<div class="form-floating">
									@{
										var branches = ViewBag.AllBranches as List<BranchDto>;
										var isSingleBranch = branches?.Count == 1;
									}
									@if (isSingleBranch)
									{
										<input type="hidden" asp-for="BranchId" />
									}
									<select asp-for="BranchId" class="form-select" id="branchSelect"
											disabled="@(isSingleBranch ? "disabled" : null)">
										@foreach (var branch in branches)
										{
											<option value="@branch.BranchId" selected="@(branch.BranchId == Model.BranchId)">
												@branch.BranchName
											</option>
										}
									</select>
									<label asp-for="BranchId">@Localizer["Branch"]</label>
									<span asp-validation-for="BranchId" class="text-danger small"></span>
								</div>
							</div>

							<!-- Gender Selection -->
							<div class="col-12 col-md-6">
								<div class="form-floating">
									<select asp-for="Gender" class="form-select" id="genderSelect">
										@foreach (var gender in Enum.GetValues(typeof(Gender)))
										{
											<option value="@((int)gender)" selected="@((int)Model.Gender == (int)gender)">
												@Localizer[gender.ToString()]
											</option>
										}
									</select>
									<label asp-for="Gender">@Localizer["Gender"]</label>
									<span asp-validation-for="Gender" class="text-danger small"></span>
								</div>
							</div>

							<!-- Age Group Selection -->
							<div class="col-12 col-md-6">
								<div class="form-floating">
									@{
										var ageGroups = ViewBag.AllAgeGroups as List<AgeGroupDto>;
									}
									<select asp-for="AgeGroupId" class="form-select" id="ageGroupSelect">
										@foreach (var ageGroup in ageGroups)
										{
											<option value="@ageGroup.AgeGroupId" selected="@(ageGroup.AgeGroupId == Model.AgeGroupId)">
												@ageGroup.Name
											</option>
										}
									</select>
									<label asp-for="AgeGroupId">@Localizer["AgeGroup"]</label>
									<span asp-validation-for="AgeGroupId" class="text-danger small"></span>
								</div>
							</div>
						</div>

						<!-- Services Selection -->
						<div class="row g-3 mb-4">
							<div class="col-12">
								<h4 class="text-primary mb-3">@Localizer["SelectedServices"]</h4>
								<div id="offeredServicesContainer">
									<div class="table-responsive">
										<table id="offeredServicesTable" class="table table-dark">
											<!-- Dynamically populated -->
										</table>
									</div>
									<div class="row mt-3">
										<div class="col-md-6 mb-1">
											<div class="form-floating">
												<input asp-for="ApproximateDuration" class="form-control"
													   type="time" />
												<label asp-for="ApproximateDuration">@Localizer["TotalDuration"]</label>
												<span asp-validation-for="ApproximateDuration" class="text-danger small"></span>
											</div>
										</div>
										<div class="col-md-6">
											<div class="form-floating">
												<input asp-for="Price" class="form-control"
													   type="number" step="0.01" />
												<label asp-for="Price">@Localizer["TotalPrice"]</label>
												<span asp-validation-for="Price" class="text-danger small"></span>
											</div>
										</div>
									</div>
								</div>
								<div id="servicesLoading" class="text-center d-none">
									<div class="spinner-border text-primary" role="status">
										<span class="visually-hidden">@Localizer["Loading"]...</span>
									</div>
								</div>
							</div>
						</div>

						<!-- Customer Information -->
						<div class="row g-3 mb-4">
							<div class="col-12">
								<h4 class="text-primary mb-3">@Localizer["CustomerInformation"]</h4>
							</div>
							<div class="col-md-6">
								<div class="form-floating">
									<input asp-for="Name" class="form-control" />
									<label asp-for="Name">@Localizer["Name"]</label>
									<span asp-validation-for="Name" class="text-danger small"></span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-floating">
									<input asp-for="Surname" class="form-control" />
									<label asp-for="Surname">@Localizer["Surname"]</label>
									<span asp-validation-for="Surname" class="text-danger small"></span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-floating">
									<input asp-for="PhoneNumber" class="form-control" type="tel" />
									<label asp-for="PhoneNumber">@Localizer["PhoneNumber"]</label>
									<span asp-validation-for="PhoneNumber" class="text-danger small"></span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-floating">
									<input asp-for="EMail" class="form-control" type="email" />
									<label asp-for="EMail">@Localizer["Email"]</label>
									<span asp-validation-for="EMail" class="text-danger small"></span>
								</div>
							</div>
						</div>

						<!-- Employee & DateTime Selection -->
						<div class="row g-3 mb-4">
							<div class="col-12">
								<h4 class="text-primary mb-3">@Localizer["AppointmentTiming"]</h4>
							</div>

							<!-- Employee Selection -->
							<div class="col-md-6">
								<div class="form-floating">
									<select asp-for="EmployeeId" class="form-select" id="employeeSelect">
										<option value="">@Localizer["LoadingEmployees"]...</option>
									</select>
									<label asp-for="EmployeeId">@Localizer["Employee"]</label>
									<span asp-validation-for="EmployeeId" class="text-danger small"></span>
								</div>
							</div>

							<!-- DateTime Selection -->
							<div class="col-md-6">
								<div class="form-floating">
									<input type="hidden" asp-for="StartDateTime" id="StartDateTime" />
									<input type="date" class="form-control" id="datePicker" disabled />
									<label>@Localizer["SelectDate"]</label>
								</div>
								<div id="timeSlots" class="row g-2 mt-2"></div>
							</div>
						</div>

						<!-- Status & Submission -->
						<div class="row g-3">
							<div class="col-12">
								<div class="form-floating">
									<select asp-for="Status" class="form-select">
										@foreach (var status in Enum.GetValues(typeof(CustomerAppointmentStatus)))
										{
											<option value="@status" selected="@status.Equals(Model.Status)">
												@Localizer[status.ToString()]
											</option>
										}
									</select>
									<label asp-for="Status">@Localizer["Status"]</label>
									<span asp-validation-for="Status" class="text-danger small"></span>
								</div>
							</div>

							<div class="col-12">
								<button type="submit" class="btn btn-primary w-100">
									<i class="bi bi-floppy me-2"></i> @Localizer["UpdateAppointment"]
								</button>
							</div>
						</div>

						<div class="text-danger small mt-3" asp-validation-summary="All"></div>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
    <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // State Management
                    let selectedServices = new Set();
                    const initialServices = new Set(@Html.Raw(JsonSerializer.Serialize(Model.OfferedServiceIds?.Select(id => id.ToString()) ?? new List<string>())));
                    let servicesLoaded = false;
                    let dateTimePickerLoaded = false;
                    let selectedDateTime = null;

                    // Form Elements
                    const form = document.querySelector('.single-step-form');
                    const branchSelect = document.getElementById('branchSelect');
                    const genderSelect = document.getElementById('genderSelect');
                    const ageGroupSelect = document.getElementById('ageGroupSelect');
                    const employeeSelect = document.getElementById('employeeSelect');
                    const datePicker = document.getElementById('datePicker');
                    const timeSlotsContainer = document.getElementById('timeSlots');

                    // Original Appointment Data
                    const originalStart = new Date("@Model.StartDateTime.ToString("o")");
                    const originalLocalISO = `${originalStart.getFullYear()}-${(originalStart.getMonth() + 1).toString().padStart(2, '0')}-${originalStart.getDate().toString().padStart(2, '0')}T${originalStart.getHours().toString().padStart(2, '0')}:${originalStart.getMinutes().toString().padStart(2, '0')}:00`;
                    const originalEnd = new Date("@Model.EndDateTime.ToString("o")");

                    // Initial Setup
                    initialServices.forEach(id => selectedServices.add(id));

                    // Initialize Form
                    function initializeForm() {
                        loadServices().then(() => {
                            loadEmployees().then(() => {
                                initializeDateTimePicker().then(() => {
                                    const initialDate = new Date("@Model.StartDateTime.ToString("o")");
                                    datePicker.value = initialDate.toISOString().split('T')[0];
                                    generateTimeSlots();
                                });
                            });
                        });
                    }

                    // Service Handling
                    async function loadServices() {
                        const container = document.getElementById('offeredServicesContainer');
                        const loader = document.getElementById('servicesLoading');
                        const table = document.getElementById('offeredServicesTable');

                        if (servicesLoaded) return;

                        try {
                            container.classList.add('d-none');
                            loader.classList.remove('d-none');

                            const response = await fetch(`/Admin/CustomerAppointment/GetOfferedServices?genderValue=${genderSelect.value}&ageGroupId=${ageGroupSelect.value}`);
                            const data = await response.json();

                            if (data.result === false) {
                                table.innerHTML = `
                                    <tbody>
                                        <tr>
                                            <td colspan="4" class="text-center text-danger py-4">
                                                ${data.message}
                                            </td>
                                        </tr>
                                    </tbody>`;
                            } else {
                                populateServicesTable(data);
                            }

                            container.classList.remove('d-none');
                            servicesLoaded = true;
                        } catch (error) {
                            console.error('Error loading services:', error);
                            table.innerHTML = `
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center text-danger py-4">
        @Localizer["ErrorLoadingServices"]
                                        </td>
                                    </tr>
                                </tbody>`;
                        } finally {
                            loader.classList.add('d-none');
                        }
                    }

                    function populateServicesTable(services) {
                        const table = document.getElementById('offeredServicesTable');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>@Localizer["Select"]</th>
                                    <th>@Localizer["Name"]</th>
                                    <th>@Localizer["Duration"]</th>
                                    <th>@Localizer["Price"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${services.map(service => `
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   name="OfferedServiceIds"
                                                   id="offeredService-${service.offeredServiceId}"
                                                   value="${service.offeredServiceId}"
                                                   ${selectedServices.has(service.offeredServiceId.toString()) ? 'checked' : ''}
                                                   class="service-checkbox form-check-input">
                                        </td>
                                        <td>${service.offeredServiceName}</td>
                                        <td>${service.approximateDuration}</td>
                                        <td>${service.price.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>`;

                        if (services.length === 0) {
                            table.innerHTML += `
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center text-warning py-4">
        @Localizer["NoServicesAvailable"]
                                        </td>
                                    </tr>
                                </tbody>`;
                        }

                        table.querySelectorAll('.service-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                this.checked ? selectedServices.add(this.value) : selectedServices.delete(this.value);
                                loadEmployees();
                                updateDurationAndPrice();
                            });
                        });

                        updateDurationAndPrice();
                    }

                    function updateDurationAndPrice() {
                        let totalMinutes = 0;
                        let totalPrice = 0;

                        document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
                            const row = checkbox.closest('tr');
                            const [hours, minutes] = row.cells[2].textContent.split(':').map(Number);
                            totalMinutes += (hours * 60) + minutes;
                            totalPrice += Number(row.cells[3].textContent);
                        });

                        const durationHours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
                        const durationMinutes = (totalMinutes % 60).toString().padStart(2, '0');
                        document.getElementById('ApproximateDuration').value = `${durationHours}:${durationMinutes}`;
                        document.getElementById('Price').value = totalPrice.toFixed(2);
                    }

                    // Employee Handling
                    async function loadEmployees() {
                        try {
                            employeeSelect.disabled = true;
                            let isSelectedEmployeeChanged = true;
                            const response = await fetch(`/Admin/CustomerAppointment/GetEmployees?branchId=${branchSelect.value}&offeredServiceIds=${Array.from(selectedServices).join(',')}`);
                            const employees = await response.json();

                            let optionsHtml = '<option value="">@Localizer["SelectEmployee"]</option>';
                            employees.forEach(employee => {
                                const isSelected = employee.employeeId === @Model.EmployeeId;
                                if (isSelected)
                                {
                                    isSelectedEmployeeChanged = false;
                                }
                                optionsHtml += `<option value="${employee.employeeId}" ${isSelected ? 'selected' : ''}>${employee.employeeName} ${employee.employeeSurname}</option>`;
                            });
                            console.log("isSelectedEmployeeChanged = " + isSelectedEmployeeChanged );
                            if(isSelectedEmployeeChanged)
                            {
                                //initializeDateTimePicker();
                                timeSlotsContainer.innerHTML = '';
                                selectedDateTime = null;
                                dateTimePickerLoaded = false;
                                datePicker.disabled = true;
                                datePicker.value = "";
                            }

                            employeeSelect.innerHTML = optionsHtml;
                            employeeSelect.disabled = false;
                        } catch (error) {
                            console.error('Error loading employees:', error);
                            employeeSelect.innerHTML = '<option value="">@Localizer["ErrorLoadingEmployees"]</option>';
                        }
                    }

                    // DateTime Handling
                    async function initializeDateTimePicker() {
                        const employeeId = employeeSelect.value;
                        const branchId = branchSelect.value;
                        console.log("dateTimePickerLoaded = " + dateTimePickerLoaded );
                        console.log("employeeId = " + employeeId );
                        console.log("branchId = " + branchId );
                        if (dateTimePickerLoaded || !employeeId || !branchId) return;
                        try {
                            const response = await fetch(`/Admin/CustomerAppointment/GetReservedDaysTimes?employeeId=${employeeId}&branchId=${branchId}`);
                            const data = await response.json();

                            const today = new Date();
                            const maxDate = new Date();
                            maxDate.setDate(today.getDate() + data.reservationInAdvanceDayLimit);

                            datePicker.min = today.toISOString().split('T')[0];
                            datePicker.max = maxDate.toISOString().split('T')[0];
                            datePicker.disabled = false;

                            window.reservationData = {
                                minDuration: data.minimumServiceDuration,
                                leaves: data.employeeLeaves,
                                reservations: data.reservedDaysTimes
                            };

                            datePicker.addEventListener('change', generateTimeSlots);
                            dateTimePickerLoaded = true;
                        } catch (error) {
                            console.error('Error loading schedule data:', error);
                            datePicker.disabled = true;
                        }
                    }

                    async function generateTimeSlots() {
            const selectedDate = new Date(datePicker.value);
            if (!selectedDate || !window.reservationData) return;

            const { minDuration, leaves, reservations } = window.reservationData;
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '<div class="spinner-border"></div>';

            try {
                // Convert API dates to Date objects
                const leavePeriods = leaves.map(leave => ({
                    start: new Date(leave.leaveStartDateTime),
                    end: new Date(leave.leaveEndDateTime)
                }));

                const reservedPeriods = reservations.map(res => ({
                    start: new Date(res.startDateTime),
                    end: new Date(res.endDateTime)
                })).filter(resPeriod =>
                    !(resPeriod.start.getTime() === originalStart.getTime() &&
                    resPeriod.end.getTime() === originalEnd.getTime())
                );

                // Clear existing content
                timeSlotsContainer.innerHTML = '';
                const fragment = document.createDocumentFragment();

                // Generate time slots
                const startHour = 0; // Opening hour
                const endHour = 24;  // Closing hour

                let currentHour = null;
                let hourContainer = null;
                let slotsRow = null;

                for (let hour = startHour; hour < endHour; hour++) {
                    for (let minute = 0; minute < 60; minute += minDuration) {
                        // Create dates in LOCAL timezone
                        const slotStart = new Date(
                            selectedDate.getFullYear(),
                            selectedDate.getMonth(),
                            selectedDate.getDate(),
                            hour,
                            minute,
                            0
                        );

                        const slotEnd = new Date(
                            slotStart.getFullYear(),
                            slotStart.getMonth(),
                            slotStart.getDate(),
                            slotStart.getHours(),
                            slotStart.getMinutes() + minDuration,
                            0
                        );

                        // Check against leaves and reservations
                        const isAvailable = !isTimeSlotOccupied(slotStart, slotEnd, leavePeriods, reservedPeriods);

                        if (isAvailable) {
                            // Get local time components
                            const localHour = slotStart.getHours();
                            const localMinutes = slotStart.getMinutes().toString().padStart(2, '0');
                            const displayTime = `${localHour.toString().padStart(2, '0')}:${localMinutes}`;

                            // Create ISO strings in LOCAL time (without timezone offset)
                            const localISODate = `${slotStart.getFullYear()}-${(slotStart.getMonth() + 1).toString().padStart(2, '0')}-${slotStart.getDate().toString().padStart(2, '0')}T${displayTime}:00`;

                            // Create hour groups
                            if (localHour !== currentHour) {
                                currentHour = localHour;
                                hourContainer = document.createElement('div');
                                hourContainer.className = 'col-12';

                                const hourHeader = document.createElement('div');
                                hourHeader.className = 'text-secondary small';
                                hourHeader.textContent = `${localHour.toString().padStart(2, '0')}:00 - ${(localHour + 1).toString().padStart(2, '0')}:00`;
                                hourContainer.appendChild(hourHeader);

                                slotsRow = document.createElement('div');
                                slotsRow.className = 'row g-1';
                                hourContainer.appendChild(slotsRow);
                                fragment.appendChild(hourContainer);
                            }

                            // Create time slot button
                            const slotCol = document.createElement('div');

                            let computed = 12 / (60 / minDuration);
                            // Ensure minimum sizes on small and medium breakpoints:
                            let colSm = computed < 2 ? 2 : computed;
                            let colMd = computed < 3 ? 3 : computed;
                            let colLg = computed < 3 ? 3 : computed;   // Use the computed value on large screens
                            let colXl = computed < 3 ? 3 : computed;   // Use the computed value on extra-large screens
                            let colXxl = computed < 2 ? 2 : computed;  // Use the computed value on extra-extra-large screens

                            // Build the column classes string
                            // Note: For mobile, it's common to start with the 'col-sm-' class
                            slotCol.className = `col-3 col-sm-${colSm} col-md-${colMd} col-lg-${colLg} col-xl-${colXl} col-xxl-${colXxl}`; 


                            const slotButton = document.createElement('button');
                            slotButton.type = 'button';
                            slotButton.className = 'btn btn-outline-light w-100 time-slot';
                            slotButton.dataset.start = localISODate;
                            slotButton.textContent = displayTime;

                            // Preselect original time
                            if (localISODate === originalLocalISO) {
                                slotButton.classList.add('active');
                                document.getElementById('StartDateTime').value = localISODate;
                                selectedDateTime = localISODate;
                            }

                            slotCol.appendChild(slotButton);
                            slotsRow.appendChild(slotCol);
                        }
                    }
                }

                timeSlotsContainer.appendChild(fragment);

                if (timeSlotsContainer.children.length === 0) {
                    timeSlotsContainer.innerHTML = '<div class="text-warning">@Localizer["NoAvailableTimeSlots"]</div>';
                }

                // Add slot selection handler
                document.querySelectorAll('.time-slot').forEach(button => {
                    button.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        document.getElementById('StartDateTime').value = this.dataset.start;
                        selectedDateTime = this.dataset.start;
                    });
                });

            } catch (error) {
                console.error('Error generating time slots:', error);
                timeSlotsContainer.innerHTML = '<div class="text-danger">@Localizer["ErrorLoadingTimeSlots"]</div>';
            }
        }

                    function isTimeSlotOccupied(start, end, leaves, reservations) {
                        return [...leaves, ...reservations].some(period =>
                            (start >= period.start && start < period.end) ||
                            (end > period.start && end <= period.end) ||
                            (start <= period.start && end >= period.end)
                        );
                    }

                    // Event Listeners
                    [branchSelect, genderSelect, ageGroupSelect].forEach(select => {
                        select.addEventListener('change', () => {
                            servicesLoaded = false;
                            selectedServices.clear();
                            loadServices();
                        });
                    });

                    employeeSelect.addEventListener('change', function() 
                    {
                        timeSlotsContainer.innerHTML = '';
                        selectedDateTime = null;
                        dateTimePickerLoaded = false;
                        datePicker.disabled = true;
                        datePicker.value = "";
                        initializeDateTimePicker();
                    });

                    // Start Initialization
                    initializeForm();
                });
    </script>
}